---
title: "DESeq2"
author: "Rajani"
date: "January 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
library("phyloseq")
packageVersion("phyloseq")
library("DESeq2") 
packageVersion("DESeq2")
library("ggplot2")
packageVersion("ggplot2")
library(tidyverse)
path <- here::here()
ps <- readRDS(file.path(path, "results", "ps_Canine.RDS"))
```

## After reading in the phyloseq object, removing any taxa which are present in less than 5 samples. Also filtering for any samples with less than 1000 reads.
```{r}
ps_Canine<-prune_taxa(taxa_sums(ps_Canine)>5,ps_Canine)
ps_Canine
```

#Extracting the otu table as a matrix for data filtering to be used for differential abundance testing for canines grouped into CD positive and negative.

```{r}
df_Canine<-as(sample_data(ps_Canine),"data.frame")
omat_Canine<-as(otu_table(ps_Canine),"matrix")
CDdp.prev<-colSums(omat_Canine[df_Canine$CD=="Positive",]>0)
CDdn.prev<-colSums(omat_Canine[df_Canine$CD=="Negative",]>0)
logical_d_pn2<-(CDdp.prev>=2 & CDdn.prev>=2)
ps_Canine_pn2<-prune_taxa(logical_d_pn2,ps_Canine)
ps_Canine_pn2
```

```{r}
#The Phyloseq object are coverted to DESeq format and are analyzed based on the differences based on CD presence/absence on CD +/- samples.
ps_Canine_desq<-phyloseq_to_deseq2(ps_Canine_pn2, ~ CD)
#Creating a geometric means function to estimate size factor
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
#Calculating geometric mean on the DESeq object
geomean_Canine<-apply(counts(ps_Canine_desq),1,gm_mean)
ps_Canine_desq<-estimateSizeFactors(ps_Canine_desq,geoMeans=geomean_Canine)
ps_Canine_desq = DESeq(ps_Canine_desq, fitType="local")

#Investigating the test results
res_Canine = results(ps_Canine_desq)
res_Canine = res_Canine[order(res_Canine$padj, na.last=NA), ]
alpha = 0.01
sigtab_Canine = res_Canine[(res_Canine$padj < alpha), ]
sigtab_Canine = cbind(as(sigtab_Canine, "data.frame"), as(tax_table(ps_Canine_pn2)[rownames(sigtab_Canine), ], "matrix"))
head(sigtab_Canine)
posigtab_Canine = sigtab_Canine[sigtab_Canine[, "log2FoldChange"] > 0, ]
posigtab_Canine = posigtab_Canine[, c("baseMean", "log2FoldChange", "lfcSE", "padj", "Phylum", "Class", "Family", "Genus")]
```
#Plotting results
```{r}
theme_set(theme_bw())
sigtabgen_Canine = subset(sigtab_Canine, !is.na(Genus))
# Family order
x = tapply(sigtabgen_Canine$log2FoldChange, sigtabgen_Canine$Family, function(x) max(x))
x = sort(x, TRUE)
sigtabgen_Canine$Family = factor(as.character(sigtabgen_Canine$Family), levels=names(x))
# Genus order
x = tapply(sigtabgen_Canine$log2FoldChange, sigtabgen_Canine$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtabgen_Canine$Genus = factor(as.character(sigtabgen_Canine$Genus), levels=names(x))
diff_abundance_Canine<-ggplot(sigtabgen_Canine, aes(y=Genus, x=log2FoldChange, color=Family)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=2.5) + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
diff_abundance_Canine
ggsave("C:/Users/rthanis/Desktop/16SsequencingForMS/Differential_abundance_Canine.pdf")
saveRDS(diff_abundance_Canine,"C:/Users/rthanis/Desktop/16SsequencingForMS/Differential_abundance_plot.rds")
```

#Extracting the otu table as a matrix for data filtering to be used for differential abundance testing for Equines.
```{r}
df_Equine<-as(sample_data(ps_Equine),"data.frame")
omat_Equine<-as(otu_table(ps_Equine),"matrix")
CDdp.prev<-colSums(omat_Equine[df_Equine$CD=="Positive",]>0)
CDdn.prev<-colSums(omat_Equine[df_Equine$CD=="Negative",]>0)
logical_d_pn2<-(CDdp.prev>=2 & CDdn.prev>=2)
ps_Equine_pn2<-prune_taxa(logical_d_pn2,ps_Equine)
ps_Equine_pn2

```

```{r}
#The Phyloseq object are coverted to DESeq format and are analyzed based on the differences based on CD presence/absence on CD +/- samples.
ps_Equine_desq<-phyloseq_to_deseq2(ps_Equine_pn2, ~ CD)
#Creating a geometric means function to estimate size factor
gm_mean = function(x, na.rm=TRUE){
  exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
}
#Calculating geometric mean on the DESeq object
geomean_Equine<-apply(counts(ps_Equine_desq),1,gm_mean) 
ps_Equine_desq<-estimateSizeFactors(ps_Equine_desq,geoMeans=geomean_Equine)
ps_Equine_desq = DESeq(ps_Equine_desq, fitType="local")

#Investigating the test results
res_Equine = results(ps_Equine_desq)
res_Equine = res_Equine[order(res_Equine$padj, na.last=NA), ]

head(res_Equine, n=5)

alpha = 0.01
# NOTE: filtering by pvalue rather than padj
sigtab_Equine = res_Equine[(res_Equine$pvalue < alpha), ]

sigtab_Equine = cbind(as(sigtab_Equine, "data.frame"), 
                      as(tax_table(ps_Equine_pn2)[rownames(sigtab_Equine), ], "matrix"))

head(sigtab_Equine)
posigtab_Equine = sigtab_Equine[sigtab_Equine[, "log2FoldChange"] > 0, ]
posigtab_Equine = posigtab_Equine[, c("baseMean", "log2FoldChange", "lfcSE", "padj", "Phylum", "Class", "Family", "Genus")]


```
```{r}
theme_set(theme_bw())
sigtabgen_Equine = subset(sigtab_Equine, !is.na(Genus))
# Family order
x = tapply(sigtabgen_Equine$log2FoldChange, sigtabgen_Equine$Family, function(x) max(x))
x = sort(x, TRUE)
sigtabgen_Equine$Family = factor(as.character(sigtabgen_Equine$Family), levels=names(x))
# Genus order
x = tapply(sigtabgen_Equine$log2FoldChange, sigtabgen_Equine$Genus, function(x) max(x))
x = sort(x, TRUE)
sigtabgen_Equine$Genus = factor(as.character(sigtabgen_Equine$Genus), levels=names(x))
diff_abundance_Equine<-ggplot(sigtabgen_Equine, aes(y=Genus, x=log2FoldChange, color=Family)) + 
  geom_vline(xintercept = 0.0, color = "gray", size = 0.5) +
  geom_point(size=2.5) + 
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust=0.5))
diff_abundance_Equine
ggsave("C:/Users/rthanis/Desktop/16SsequencingForMS/Differential_abundance_Equine.pdf")
saveRDS(diff_abundance_Equine,"C:/Users/rthanis/Desktop/16SsequencingForMS/Differential_abundance_Equineplot.rds")
```

#Extracting the otu table as a matrix for data filtering to be used for differential abundance testing for canines grouped into CD positive and negative.

```{r}
(ps_CanineAb <- subset_samples(ps_Canine, Ab != "NA"))
saveRDS(ps_CanineAb ,"C:/Users/rthanis/Desktop/16SsequencingForMS/ps_CanineAb.RDS")
ps_CanineAb
df_Canine<-as(sample_data(ps_CanineAb),"data.frame")
omat_Canine<-as(otu_table(ps_CanineAb),"matrix")
Ab.pos<-colSums(omat_Canine[df_Canine$Ab=="yes",]>0)
Ab.neg<-colSums(omat_Canine[df_Canine$Ab=="no",]>0)
logical_d_pn2<-(Ab.pos>=2 & Ab.neg>=2)
ps_CanineAb_pn2<-prune_taxa(logical_d_pn2,ps_CanineAb)
ps_CanineAb_pn2
```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
